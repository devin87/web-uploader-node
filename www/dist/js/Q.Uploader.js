//devin87@qq.com
//build:2021/03/11 11:23:14
!function(e,o){"use strict";var a=Q.def,u=Q.fire,i=Q.extend,l=Q.getFirst,n=Q.getLast,d=JSON.parse,s=Q.createEle,c=Q.parseHTML,p=Q.setOpacity,f=Q.getOffset||Q.offset,h=Q.md5File,t=Q.event,m=t.add,g=t.trigger,v=t.stop,_=!1,y=!1,w=!1,r=0,T=0,k=0,x=-1,S={};function b(e,t){t=e.lastIndexOf(t);return-1!=t?e.slice(t):""}function I(e){if(e){for(var t=e.split(","),r={},a=0,i=t.length;a<i;a++)r[t[a]]=!0;return r}}function E(e){var t=this,e=e||{};t.guid=e.guid||"uploader"+ ++r,t.list=[],t.map={},t.index=0,t.started=!1,t.set(e)._init()}E.prototype={constructor:E,set:function(e){var t=this,r=i(e,t.ops);t.url=r.url,t.dataType=r.dataType||"json",t.data=r.data,t.targets=r.target||[],t.targets.forEach||(t.targets=[t.targets]),t.target=t.targets[0],t.html5=_&&!!a(r.html5,!0),t.multiple=y&&t.html5&&!!a(r.multiple,!0),t.clickTrigger=w&&!!a(r.clickTrigger,!0),t.workerThread=t.html5&&r.workerThread||1,t.workerIdle=t.workerThread,t.auto=!1!==r.auto,t.upName=r.upName||"upfile",t.accept=r.accept||(0==(navigator.platform||"").indexOf("Win")?r.allows:"*/*"),t.isDir=r.isDir,t.allows=I(r.allows),t.disallows=I(r.disallows),t.maxSize=+r.maxSize||0,t.isSlice=!!r.isSlice,t.chunkSize=+r.chunkSize||2097152,t.isQueryState=!!a(r.isQueryState,t.isSlice),t.isMd5=!!a(r.isMd5,t.isSlice),t.isUploadAfterHash=!1!==r.isUploadAfterHash,t.sliceRetryCount=r.sliceRetryCount==o?2:+r.sliceRetryCount||0,t.urlForQuery=r.urlForQuery||t.url,t.container=r.container||document.body,r.getPos&&(t.getPos=r.getPos);e=r.UI||{};return e.init&&(t.init=e.init),e.draw&&(t.draw=e.draw),e.update&&(t.update=e.update),e.over&&(t.over=e.over),t.fns=r.on||{},t.ops=r,t.accept&&!t.clickTrigger&&t.resetInput(),t},_init:function(){var t=this;if(!t._inited){t._inited=!0;var r,e=t.guid,a=t.container,i=s("div","upload-input "+e);return a.appendChild(i),t.boxInput=i,t.html5||(e=s("div","upload-html4 "+e,'<iframe class="u-iframe" name="'+(e="upload_iframe_"+e)+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+e+'"></form>'),a.appendChild(e),r=l(e),a=n(e),t.iframe=r,t.form=a,e=function(){if(0==t.workerIdle){var e;try{e=r.contentWindow.document.body.innerHTML}catch(e){}t.complete(o,2,e)}},(a=r).attachEvent?a.attachEvent("onload",e):a.addEventListener("load",e,!1)),t.targets.forEach(function(e){t.clickTrigger?m(e,"click",function(e){!1!==t.fire("select",e)&&(t.resetInput(),g(t.inputFile,"click"))}):m(e,"mouseover",function(e){t.target=this,t.updatePos()})}),t.clickTrigger||(m(i,"click",function(e){!1===t.fire("select",e)&&v(e)}),p(i,0),t.resetInput()),t.run("init",o,"init")}},resetInput:function(){var t=this,e=t.boxInput;if(!e)return t;e.innerHTML='<input type="file" name="'+t.upName+'"'+(t.accept?'accept="'+t.accept+'"':"")+(t.isDir?'webkitdirectory=""':"")+' style="'+(t.clickTrigger?"visibility: hidden;":"font-size:100px;")+'"'+(t.multiple?' multiple="multiple"':"")+">";e=l(e);return m(e,"change",function(e){t.add(this),t.html5||t.resetInput()}),t.inputFile=e,t.updatePos()},updatePos:function(e){var t=this;if(t.clickTrigger)return t;var r=t.getPos||f,a=t.boxInput,i=l(a),n=t.target,s=n.offsetWidth,o=n.offsetHeight,n=0==s?{left:-1e4,top:-1e4}:r(n);return a.style.width=i.style.width=s+"px",a.style.height=i.style.height=o+"px",a.style.left=n.left+"px",a.style.top=n.top+"px",e&&(a.style.zIndex=++k),t},fire:function(e,t,r){if(!r)return u(this.fns[e],this,t);var a=this.fns[e+"Async"];if(a)return u(a,this,t,r);r(u(this.fns[e],this,t))},run:function(e,t,r){e=this[e];return e&&u(e,this,t),r&&u(this.fns[r],this,t),this},addTask:function(e,t){if(e||t){var r,a,i=t?(r=t.webkitRelativePath||t.name||t.fileName,0===t.size?0:t.size||t.fileSize):(r=b(e.value,"\\").slice(1)||e.value,-1),n=this,s=b(r,".").toLowerCase();n.disallows&&n.disallows[s]||n.allows&&!n.allows[s]?a="ext":-1!=i&&n.maxSize&&i>n.maxSize&&(a="size");var o={id:++T,name:r,ext:s,size:i,input:e,file:t,state:a?x:0};return a&&(o.limited=a,o.disabled=!0),n.fire("add",o,function(e){!1===e||o.disabled||o.limited||(o.index=n.list.length,n.list.push(o),n.map[o.id]=o,n.run("draw",o,"draw"),n.auto&&n.start())}),o}},add:function(e){if("INPUT"==e.tagName){var t=e.files;if(t)for(var r=0,a=t.length;r<a;r++)this.addTask(e,t[r]);else this.addTask(e)}else this.addTask(o,e)},addList:function(e){for(var t=0,r=e.length;t<r;t++)this.add(e[t])},get:function(e){if(e!=o)return this.map[e]},cancel:function(e,t){var r=this,a=r.get(e);if(a){e=a.state;if(0!=e&&1!=e)return r;if(1==e){e=a.xhr;if(e)return e.abort(),r;r.iframe.contentWindow.location="about:blank"}return t?r:r.complete(a,-2)}},remove:function(e){var t=this.get(e);t&&(1==t.state&&this.cancel(e),t.deleted=!0,this.fire("remove",t))},start:function(){var e=this,t=e.workerIdle,r=e.list,a=e.index,i=r.length;if(e.started||(e.started=!0),i<=0||i<=a||t<=0)return e;a=r[a];return e.index++,e.upload(a)},upload:function(t){var r=this;return!t||0!=t.state||t.skip||t.deleted?r.start():(t.url=r.url,r.workerIdle--,r.fire("upload",t,function(e){return!1===e?r.complete(t,x):void(r.html5&&t.file?r._upload_html5_ready(t):t.input?r._upload_html4(t):r.complete(t,x))}),r)},_process_xhr_headers:function(r){function e(e,t){r.setRequestHeader(e,t)}var t=this.ops;S.headers&&Object.forEach(S.headers,e),t.headers&&Object.forEach(t.headers,e)},queryState:function(a,i){var n=this,e=n.urlForQuery,s=new XMLHttpRequest,r=["action=query","hash="+(a.hash||encodeURIComponent(a.name)),"fileName="+encodeURIComponent(a.name)];return-1!=a.size&&r.push("fileSize="+a.size),n._process_params(a,function(e,t){r.push(encodeURIComponent(e)+"="+(t!=o?encodeURIComponent(t):""))},"dataQuery"),a.queryUrl=e+(-1==e.indexOf("?")?"?":"&")+r.join("&"),n.fire("beforeQuery",a),n.fire("sliceQuery",a),s.open("GET",a.queryUrl),n._process_xhr_headers(s),s.onreadystatechange=function(){if(4==s.readyState){if(s.status<200||400<=s.status)return u(i,n,s);var r,e=s.responseText;"ok"===e?r={data:{ok:!0}}:e&&(r=d(e)),r&&"number"!=typeof r||(r={data:{start:r}}),a.response=e,a.json=r,n.fire("query",a,function(e){var t;-1==(e=e==o?(t=r?r.data:o)?t.ok||t.url?-1:t.start:1==r.ret?-1:r.start:e)?(a.queryOK=!0,n.cancel(a.id,!0).complete(a,2)):((e=+e||0)!=Math.floor(e)&&(e=0),a.sliceStart=e),u(i,n,s)})}},s.onerror=function(){u(i,n,s)},s.send(null),n},_upload_html5_ready:function(a){function e(){2!=a.state&&(n.isSlice?n._upload_slice(a):n._upload_html5(a))}function i(e){a.hash&&n.isQueryState&&2!=a.state?n.queryState(a,e):e()}function t(r){n.fire("hash",a,function(){if(a.hash||!n.isMd5||!h)return i(r);var t=n.fns.hashProgress;h(a.file,function(e,t){a.hash=e,a.timeHash=t,i(r)},function(e){u(t,n,a,e)})})}var n=this;return n.isUploadAfterHash?t(e):(e(),t()),n},_process_params:function(e,t,r){r=r||"data",S.data&&Object.forEach(S.data,t),this.data&&Object.forEach(this.data,t),e&&e[r]&&Object.forEach(e[r],t)},_upload_html5:function(t){var r=this,a=new XMLHttpRequest;(t.xhr=a).upload.addEventListener("progress",function(e){r.progress(t,e.total,e.loaded)},!1),a.addEventListener("load",function(e){r.complete(t,2,e.target.responseText)},!1),a.addEventListener("error",function(){r.complete(t,-3)},!1),a.addEventListener("abort",function(){r.complete(t,-2)},!1);var i=new FormData;r._process_params(t,function(e,t){i.append(e,t)}),i.append("fileName",t.name),i.append(r.upName,t.blob||t.file,t.name),a.open("POST",t.url),r._process_xhr_headers(a),r.fire("send",t,function(e){return!1===e?r.complete(t,x):(a.send(i),void r._afterSend(t))})},_upload_html4:function(t){var r=this,a=r.form,e=t.input;if(e._uploaded)return r.complete(t,2);e._uploaded=!0,e.name=r.upName,a.innerHTML="",a.appendChild(e),a.action=t.url,r._process_params(t,function(e,t){a.appendChild(c('<input type="hidden" name="'+e+'" value="'+t+'">'))}),r.fire("send",t,function(e){return!1===e?r.complete(t,x):(a.submit(),void r._afterSend(t))})},_afterSend:function(e){e.lastTime=e.startTime=Date.now(),e.state=1,this._lastTask=e,this.progress(e)},progress:function(e,t,r){t=t||e.size,(!r||r<0)&&(r=0);var a=e.state||0;0<(r=t<r?t:r)&&0==a&&(e.state=a=1),function(e,t,r){if(t&&!(t<=0)){var a,i=Date.now();if(t<=r)return(a=i-e.startTime)?e.avgSpeed=Math.min(Math.round(1e3*t/a),t):e.speed||(e.avgSpeed=e.speed=t),e.time=a||0,e.endTime=i;(a=i-e.lastTime)<200||(e.speed=Math.min(Math.round(1e3*(r-e.loaded)/a),e.total),e.lastTime=i)}}(e,t=2==a?r=e.size:t,r),e.total=t,e.loaded=r,this.run("update",e,"progress")},_process_response:function(e,t){(e.response=t)&&"json"==this.dataType&&(e.json=d(t))},complete:function(e,t,r){var a=this;return(e=!e&&1==a.workerThread?a._lastTask:e)&&(t!=o&&(e.state=t),1!=e.state&&2!=t||(e.state=2,a.progress(e,e.size,e.size)),r!==o&&a._process_response(e,r)),a.run("update",e,"update").run("over",e,"over"),-2==t&&a.fire("cancel",e),a.fire("complete",e),a.workerIdle++,a.started&&a.start(),a}},E.extend=function(e,t){i(E.prototype,e,t)},(t=e.XMLHttpRequest)&&(new t).upload&&e.FormData&&(_=!0),(t=document.createElement("input")).type="file",y=!!t.files,i(E,{support:{html5:w=_,multiple:y},READY:0,PROCESSING:1,COMPLETE:2,SKIP:x,CANCEL:-2,ERROR:-3,UI:{},Lang:{status_ready:"准备中",status_processing:"上传中",status_complete:"已完成",status_skip:"已跳过",status_cancel:"已取消",status_error:"已失败"},setup:function(e){i(S,e,!0)},getStatusText:function(e){var t=E.Lang;switch(e){case 0:return t.status_ready;case 1:return t.status_processing;case 2:return t.status_complete;case x:return t.status_skip;case-2:return t.status_cancel;case-3:return t.status_error}return e}}),Q.Uploader=E}(window);